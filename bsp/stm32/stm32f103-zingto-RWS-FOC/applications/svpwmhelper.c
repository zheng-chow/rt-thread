#include <rtthread.h>
#include "svpwmhelper.h"
#include <math.h>
#define PI	 			(acos(-1.0))
#define DEG2RAD		(PI/180.f)
#define RAD2DEG		(180.f/PI)
#define PI_DIV3		(PI/3)
#define PI_DIV2		(PI/2)
#define PI_DIV6		(PI/6)
#define SQRT_3		(sqrt(3.0))



/*
float FastSin(float deg){
	float rad = 0;
	float fastsin = 0;
	if (deg< -180)
    deg+= 360;
	else if (deg>  180)
    deg-= 360;
	rad = DEG2RAD * deg;
	
	if (rad< 0)
	{
			fastsin= 1.27323954 * rad+ .405284735 * rad* rad;

		 if (fastsin< 0)
					fastsin= 0.225 * (fastsin*-fastsin- fastsin) + fastsin;
		 else
					fastsin= 0.225 * (fastsin* fastsin- fastsin) + fastsin;
	}
	else
	{
			fastsin= 1.27323954 * rad- 0.405284735 * rad* rad;

		 if (fastsin< 0)
					fastsin= 0.225 * (fastsin*-fastsin- fastsin) + fastsin;
		 else
					fastsin= 0.225 * (fastsin* fastsin- fastsin) + fastsin;
	}
	return fastsin;	
}
float FastCos(float deg){
	float rad = 0;
	float fastcos = 0;
	if (deg< -180)
    deg+= 360;
	else if (deg>  180)
    deg-= 360;
	
	deg+= 90;
	if (deg>  180)
			deg-= 360;
	
	rad = DEG2RAD * deg;

	if (rad< 0)
	{
			fastcos= 1.27323954 * rad+ 0.405284735 * rad* rad;

		 if (fastcos< 0)
					fastcos= 0.225 * (fastcos*-fastcos- fastcos) + fastcos;
		 else
					fastcos= 0.225 * (fastcos* fastcos- fastcos) + fastcos;
	}
	else
	{
			fastcos= 1.27323954 * rad- 0.405284735 * rad* rad;

		 if (fastcos< 0)
					fastcos= 0.225 * (fastcos*-fastcos- fastcos) + fastcos;
		 else
					fastcos= 0.225 * (fastcos* fastcos- fastcos) + fastcos;
	
 }
	return fastcos;
}
float Svpwm_PhaseA(rt_uint16_t elec_ratio, float elec_angle){
	
	float coef = elec_ratio / 65535.f;
	float result = 0.f;
	elec_angle += 330;
	if (elec_angle >= 360){
		elec_angle -= 360;
	}
	if (elec_angle >= (300.f)) {
		result = (0.5f + 0.5f*coef*FastSin(60 - elec_angle));
	}
	else if (elec_angle >= (240.f)) {
		result = (0.5f + 0.5f*SQRT_3*coef*FastCos(elec_angle));
	}
	else if (elec_angle >= (180.f))	{
		result = (0.5f + 0.5f*coef*FastSin(60 + elec_angle));
	}
	else if (elec_angle >= (120.f))	{
		result = (0.5f + 0.5f*coef*FastSin(60 - elec_angle));
	}
	else if (elec_angle >= (60.f)) {
		result = (0.5f + 0.5f*SQRT_3*coef*FastCos(elec_angle));
	}
	else {
		result = (0.5f + 0.5f*coef*FastSin(60 + elec_angle));
	}
	return result;
}
	
float Svpwm_PhaseB(rt_uint16_t elec_ratio, float elec_angle){
	float coef = elec_ratio / 65535.f;
	float result = 0.f;
	elec_angle += 330;
	if (elec_angle >= 360){
		elec_angle -= 360;
	}
	if (elec_angle >= (300.f)) {
		result = (0.5f + 0.5f*coef*FastSin(elec_angle - 60));
	}
	else if (elec_angle >= (240.f)) {
		result = (0.5f + 0.5f*coef*FastSin(elec_angle));
	}
	else if (elec_angle >= (180.f)) {
		result = (0.5f - 0.5f*SQRT_3*coef*FastCos(60 + elec_angle));
	}
	else if (elec_angle >= (120.f)) {
		result = (0.5f + 0.5f*coef*FastSin(elec_angle - 60));
	}
	else if (elec_angle >= (60.f)) {
		result = (0.5f + 0.5f*coef*FastSin(elec_angle));
	}
	else {
		result = (0.5f - 0.5f*SQRT_3*coef*FastCos(60 + elec_angle));
	}
	return result;
}
float Svpwm_PhaseC(rt_uint16_t elec_ratio, float elec_angle){
	float coef = elec_ratio / 65535.f;
	float result = 0.f;
	elec_angle += 330;
	if (elec_angle >= 360){
		elec_angle -= 360;
	}
	if (elec_angle >= (300.f)) {
		result = (0.5f - 0.5f*SQRT_3*coef*FastCos(60 - elec_angle));
	}
	else if (elec_angle >= (240.f)) {
		result = (0.5f - 0.5f*coef*FastSin(elec_angle));
	}
	else if (elec_angle >= (180.f)) {
		result = (0.5f - 0.5f*coef*FastSin(60 + elec_angle));
	}
	else if (elec_angle >= (120.f))	{
		result = (0.5f - 0.5f*SQRT_3*coef*FastCos(60 - elec_angle));
	}
	else if (elec_angle >= (60.f)) {
		result = (0.5f - 0.5f*coef*FastSin(elec_angle));
	}
	else {
		result = (0.5f - 0.5f*coef*FastSin(60 + elec_angle));
	}	
	return result;
}
*/
#if 0
float Svpwm_PhaseA(rt_uint16_t elec_ratio, float elec_angle){
	
	float coef = elec_ratio / 65535.f;
	float result = 0.f;
	elec_angle += 330;
	if (elec_angle >= 360){
		elec_angle -= 360;
	}
	if (elec_angle >= (300.f)) {
		result = (0.5f + 0.5f*coef*sinf(PI_DIV3 - elec_angle*DEG2RAD));
	}
	else if (elec_angle >= (240.f)) {
		result = (0.5f + 0.5f*SQRT_3*coef*cosf(elec_angle*DEG2RAD));
	}
	else if (elec_angle >= (180.f))	{
		result = (0.5f + 0.5f*coef*sinf(PI_DIV3 + elec_angle*DEG2RAD));
	}
	else if (elec_angle >= (120.f))	{
		result = (0.5f + 0.5f*coef*sinf(PI_DIV3 - elec_angle*DEG2RAD));
	}
	else if (elec_angle >= (60.f)) {
		result = (0.5f + 0.5f*SQRT_3*coef*cosf(elec_angle*DEG2RAD));
	}
	else {
		result = (0.5f + 0.5f*coef*sinf(PI_DIV3 + elec_angle*DEG2RAD));
	}
	return result;
}
	
float Svpwm_PhaseB(rt_uint16_t elec_ratio, float elec_angle){
	float coef = elec_ratio / 65535.f;
	float result = 0.f;
	elec_angle += 330;
	if (elec_angle >= 360){
		elec_angle -= 360;
	}
	if (elec_angle >= (300.f)) {
		result = (0.5f + 0.5f*coef*sinf(elec_angle*DEG2RAD - PI_DIV3));
	}
	else if (elec_angle >= (240.f)) {
		result = (0.5f + 0.5f*coef*sinf(elec_angle*DEG2RAD));
	}
	else if (elec_angle >= (180.f)) {
		result = (0.5f - 0.5f*SQRT_3*coef*cosf(PI_DIV3 + elec_angle*DEG2RAD));
	}
	else if (elec_angle >= (120.f)) {
		result = (0.5f + 0.5f*coef*sinf(elec_angle*DEG2RAD - PI_DIV3));
	}
	else if (elec_angle >= (60.f)) {
		result = (0.5f + 0.5f*coef*sinf(elec_angle*DEG2RAD));
	}
	else {
		result = (0.5f - 0.5f*SQRT_3*coef*cosf(PI_DIV3 + elec_angle*DEG2RAD));
	}
	return result;
}
float Svpwm_PhaseC(rt_uint16_t elec_ratio, float elec_angle){
	float coef = elec_ratio / 65535.f;
	float result = 0.f;
	elec_angle += 330;
	if (elec_angle >= 360){
		elec_angle -= 360;
	}
	if (elec_angle >= (300.f)) {
		result = (0.5f - 0.5f*SQRT_3*coef*cosf(PI_DIV3 - elec_angle*DEG2RAD));
	}
	else if (elec_angle >= (240.f)) {
		result = (0.5f - 0.5f*coef*sinf(elec_angle*DEG2RAD));
	}
	else if (elec_angle >= (180.f)) {
		result = (0.5f - 0.5f*coef*sinf(PI_DIV3 + elec_angle*DEG2RAD));
	}
	else if (elec_angle >= (120.f))	{
		result = (0.5f - 0.5f*SQRT_3*coef*cosf(PI_DIV3 - elec_angle*DEG2RAD));
	}
	else if (elec_angle >= (60.f)) {
		result = (0.5f - 0.5f*coef*sinf(elec_angle*DEG2RAD));
	}
	else {
		result = (0.5f - 0.5f*coef*sinf(PI_DIV3 + elec_angle*DEG2RAD));
	}	
	return result;
}
#elif 0


static const float COS_TB[1000] = { 
1.000000f, 0.999980f, 0.999921f, 0.999822f, 0.999684f, 0.999506f, 0.999288f, 0.999031f, 0.998734f, 0.998398f,
0.998023f, 0.997608f, 0.997153f, 0.996659f, 0.996126f, 0.995553f, 0.994941f, 0.994289f, 0.993599f, 0.992868f,
0.992099f, 0.991290f, 0.990442f, 0.989555f, 0.988629f, 0.987664f, 0.986659f, 0.985616f, 0.984533f, 0.983412f,
0.982252f, 0.981053f, 0.979815f, 0.978538f, 0.977223f, 0.975869f, 0.974476f, 0.973045f, 0.971575f, 0.970067f,
0.968521f, 0.966936f, 0.965313f, 0.963651f, 0.961952f, 0.960215f, 0.958439f, 0.956626f, 0.954775f, 0.952886f,
0.950959f, 0.948995f, 0.946993f, 0.944954f, 0.942877f, 0.940764f, 0.938612f, 0.936424f, 0.934199f, 0.931937f,
0.929638f, 0.927302f, 0.924929f, 0.922520f, 0.920074f, 0.917592f, 0.915074f, 0.912519f, 0.909929f, 0.907302f,
0.904640f, 0.901941f, 0.899207f, 0.896438f, 0.893633f, 0.890792f, 0.887917f, 0.885006f, 0.882060f, 0.879080f,
0.876064f, 0.873014f, 0.869930f, 0.866811f, 0.863657f, 0.860470f, 0.857248f, 0.853993f, 0.850704f, 0.847381f,
0.844024f, 0.840635f, 0.837212f, 0.833756f, 0.830267f, 0.826745f, 0.823190f, 0.819603f, 0.815983f, 0.812331f,
0.808647f, 0.804931f, 0.801183f, 0.797404f, 0.793593f, 0.789750f, 0.785876f, 0.781972f, 0.778036f, 0.774069f,
0.770072f, 0.766044f, 0.761987f, 0.757898f, 0.753780f, 0.749633f, 0.745455f, 0.741248f, 0.737012f, 0.732746f,
0.728452f, 0.724128f, 0.719777f, 0.715396f, 0.710987f, 0.706551f, 0.702086f, 0.697593f, 0.693073f, 0.688526f,
0.683951f, 0.679349f, 0.674720f, 0.670065f, 0.665383f, 0.660675f, 0.655940f, 0.651180f, 0.646394f, 0.641582f,
0.636745f, 0.631883f, 0.626996f, 0.622084f, 0.617147f, 0.612186f, 0.607201f, 0.602192f, 0.597159f, 0.592102f,
0.587022f, 0.581918f, 0.576792f, 0.571643f, 0.566471f, 0.561277f, 0.556060f, 0.550822f, 0.545562f, 0.540280f,
0.534977f, 0.529653f, 0.524307f, 0.518941f, 0.513555f, 0.508148f, 0.502721f, 0.497274f, 0.491808f, 0.486322f,
0.480816f, 0.475292f, 0.469749f, 0.464188f, 0.458608f, 0.453010f, 0.447394f, 0.441760f, 0.436109f, 0.430440f,
0.424755f, 0.419052f, 0.413334f, 0.407598f, 0.401847f, 0.396080f, 0.390297f, 0.384499f, 0.378685f, 0.372856f,
0.367013f, 0.361155f, 0.355283f, 0.349397f, 0.343497f, 0.337584f, 0.331657f, 0.325717f, 0.319764f, 0.313798f,
0.307820f, 0.301830f, 0.295828f, 0.289814f, 0.283789f, 0.277753f, 0.271705f, 0.265647f, 0.259578f, 0.253499f,
0.247410f, 0.241312f, 0.235203f, 0.229086f, 0.222959f, 0.216823f, 0.210679f, 0.204527f, 0.198366f, 0.192198f,
0.186022f, 0.179839f, 0.173648f, 0.167451f, 0.161247f, 0.155037f, 0.148820f, 0.142598f, 0.136370f, 0.130136f,
0.123898f, 0.117655f, 0.111406f, 0.105154f, 0.098897f, 0.092637f, 0.086373f, 0.080105f, 0.073834f, 0.067560f,
0.061284f, 0.055005f, 0.048724f, 0.042441f, 0.036157f, 0.029871f, 0.023583f, 0.017295f, 0.011006f, 0.004717f,
-0.001572f, -0.007862f, -0.014151f, -0.020439f, -0.026727f, -0.033014f, -0.039299f, -0.045583f, -0.051865f, -0.058145f,
-0.064422f, -0.070698f, -0.076970f, -0.083239f, -0.089505f, -0.095767f, -0.102026f, -0.108281f, -0.114531f, -0.120777f,
-0.127018f, -0.133254f, -0.139485f, -0.145710f, -0.151929f, -0.158143f, -0.164350f, -0.170550f, -0.176744f, -0.182931f,
-0.189111f, -0.195283f, -0.201448f, -0.207604f, -0.213752f, -0.219892f, -0.226023f, -0.232146f, -0.238259f, -0.244362f,
-0.250456f, -0.256540f, -0.262614f, -0.268678f, -0.274730f, -0.280772f, -0.286803f, -0.292823f, -0.298831f, -0.304827f,
-0.310811f, -0.316783f, -0.322742f, -0.328688f, -0.334622f, -0.340542f, -0.346449f, -0.352342f, -0.358221f, -0.364086f,
-0.369937f, -0.375773f, -0.381594f, -0.387400f, -0.393190f, -0.398965f, -0.404725f, -0.410468f, -0.416195f, -0.421906f,
-0.427600f, -0.433277f, -0.438936f, -0.444579f, -0.450204f, -0.455811f, -0.461400f, -0.466971f, -0.472523f, -0.478057f,
-0.483571f, -0.489067f, -0.494543f, -0.500000f, -0.505437f, -0.510854f, -0.516251f, -0.521627f, -0.526983f, -0.532317f,
-0.537631f, -0.542924f, -0.548195f, -0.553444f, -0.558671f, -0.563877f, -0.569060f, -0.574220f, -0.579358f, -0.584473f,
-0.589565f, -0.594633f, -0.599678f, -0.604699f, -0.609697f, -0.614670f, -0.619619f, -0.624543f, -0.629443f, -0.634317f,
-0.639167f, -0.643991f, -0.648790f, -0.653563f, -0.658311f, -0.663032f, -0.667727f, -0.672396f, -0.677038f, -0.681653f,
-0.686242f, -0.690803f, -0.695337f, -0.699843f, -0.704322f, -0.708773f, -0.713195f, -0.717590f, -0.721956f, -0.726294f,
-0.730603f, -0.734883f, -0.739134f, -0.743355f, -0.747547f, -0.751710f, -0.755843f, -0.759946f, -0.764019f, -0.768062f,
-0.772074f, -0.776056f, -0.780007f, -0.783928f, -0.787817f, -0.791675f, -0.795502f, -0.799297f, -0.803061f, -0.806793f,
-0.810493f, -0.814161f, -0.817797f, -0.821400f, -0.824971f, -0.828510f, -0.832015f, -0.835488f, -0.838927f, -0.842334f,
-0.845707f, -0.849046f, -0.852352f, -0.855625f, -0.858863f, -0.862068f, -0.865238f, -0.868374f, -0.871476f, -0.874543f,
-0.877576f, -0.880574f, -0.883537f, -0.886466f, -0.889359f, -0.892217f, -0.895040f, -0.897827f, -0.900579f, -0.903295f,
-0.905975f, -0.908620f, -0.911228f, -0.913801f, -0.916338f, -0.918838f, -0.921302f, -0.923729f, -0.926120f, -0.928474f,
-0.930792f, -0.933072f, -0.935316f, -0.937523f, -0.939693f, -0.941825f, -0.943920f, -0.945978f, -0.947999f, -0.949982f,
-0.951927f, -0.953835f, -0.955705f, -0.957537f, -0.959332f, -0.961088f, -0.962807f, -0.964487f, -0.966129f, -0.967733f,
-0.969299f, -0.970826f, -0.972315f, -0.973765f, -0.975177f, -0.976551f, -0.977885f, -0.979181f, -0.980439f, -0.981657f,
-0.982837f, -0.983978f, -0.985080f, -0.986142f, -0.987166f, -0.988151f, -0.989097f, -0.990004f, -0.990871f, -0.991699f,
-0.992489f, -0.993238f, -0.993949f, -0.994620f, -0.995252f, -0.995844f, -0.996397f, -0.996911f, -0.997385f, -0.997820f,
-0.998215f, -0.998571f, -0.998888f, -0.999164f, -0.999402f, -0.999600f, -0.999758f, -0.999876f, -0.999955f, -0.999995f,
-0.999995f, -0.999955f, -0.999876f, -0.999758f, -0.999600f, -0.999402f, -0.999164f, -0.998888f, -0.998571f, -0.998215f,
-0.997820f, -0.997385f, -0.996911f, -0.996397f, -0.995844f, -0.995252f, -0.994620f, -0.993949f, -0.993238f, -0.992489f,
-0.991699f, -0.990871f, -0.990004f, -0.989097f, -0.988151f, -0.987166f, -0.986142f, -0.985080f, -0.983978f, -0.982837f,
-0.981657f, -0.980439f, -0.979181f, -0.977885f, -0.976551f, -0.975177f, -0.973765f, -0.972315f, -0.970826f, -0.969299f,
-0.967733f, -0.966129f, -0.964487f, -0.962807f, -0.961088f, -0.959332f, -0.957537f, -0.955705f, -0.953835f, -0.951927f,
-0.949982f, -0.947999f, -0.945978f, -0.943920f, -0.941825f, -0.939693f, -0.937523f, -0.935316f, -0.933072f, -0.930792f,
-0.928474f, -0.926120f, -0.923729f, -0.921302f, -0.918838f, -0.916338f, -0.913801f, -0.911228f, -0.908620f, -0.905975f,
-0.903295f, -0.900579f, -0.897827f, -0.895040f, -0.892217f, -0.889359f, -0.886466f, -0.883537f, -0.880574f, -0.877576f,
-0.874543f, -0.871476f, -0.868374f, -0.865238f, -0.862068f, -0.858863f, -0.855625f, -0.852352f, -0.849046f, -0.845707f,
-0.842334f, -0.838927f, -0.835488f, -0.832015f, -0.828510f, -0.824971f, -0.821400f, -0.817797f, -0.814161f, -0.810493f,
-0.806793f, -0.803061f, -0.799297f, -0.795502f, -0.791675f, -0.787817f, -0.783928f, -0.780007f, -0.776056f, -0.772074f,
-0.768062f, -0.764019f, -0.759946f, -0.755843f, -0.751710f, -0.747547f, -0.743355f, -0.739134f, -0.734883f, -0.730603f,
-0.726294f, -0.721956f, -0.717590f, -0.713195f, -0.708773f, -0.704322f, -0.699843f, -0.695337f, -0.690803f, -0.686242f,
-0.681653f, -0.677038f, -0.672396f, -0.667727f, -0.663032f, -0.658311f, -0.653563f, -0.648790f, -0.643991f, -0.639167f,
-0.634317f, -0.629443f, -0.624543f, -0.619619f, -0.614670f, -0.609697f, -0.604699f, -0.599678f, -0.594633f, -0.589565f,
-0.584473f, -0.579358f, -0.574220f, -0.569060f, -0.563877f, -0.558671f, -0.553444f, -0.548195f, -0.542924f, -0.537631f,
-0.532317f, -0.526983f, -0.521627f, -0.516251f, -0.510854f, -0.505437f, -0.500000f, -0.494543f, -0.489067f, -0.483571f,
-0.478057f, -0.472523f, -0.466971f, -0.461400f, -0.455811f, -0.450204f, -0.444579f, -0.438936f, -0.433277f, -0.427600f,
-0.421906f, -0.416195f, -0.410468f, -0.404725f, -0.398965f, -0.393190f, -0.387400f, -0.381594f, -0.375773f, -0.369937f,
-0.364086f, -0.358221f, -0.352342f, -0.346449f, -0.340542f, -0.334622f, -0.328688f, -0.322742f, -0.316783f, -0.310811f,
-0.304827f, -0.298831f, -0.292823f, -0.286803f, -0.280772f, -0.274730f, -0.268678f, -0.262614f, -0.256540f, -0.250456f,
-0.244362f, -0.238259f, -0.232146f, -0.226023f, -0.219892f, -0.213752f, -0.207604f, -0.201448f, -0.195283f, -0.189111f,
-0.182931f, -0.176744f, -0.170550f, -0.164350f, -0.158143f, -0.151929f, -0.145710f, -0.139485f, -0.133254f, -0.127018f,
-0.120777f, -0.114531f, -0.108281f, -0.102026f, -0.095767f, -0.089505f, -0.083239f, -0.076970f, -0.070698f, -0.064422f,
-0.058145f, -0.051865f, -0.045583f, -0.039299f, -0.033014f, -0.026727f, -0.020439f, -0.014151f, -0.007862f, -0.001572f,
0.004717f, 0.011006f, 0.017295f, 0.023583f, 0.029871f, 0.036157f, 0.042441f, 0.048724f, 0.055005f, 0.061284f,
0.067560f, 0.073834f, 0.080105f, 0.086373f, 0.092637f, 0.098897f, 0.105154f, 0.111406f, 0.117655f, 0.123898f,
0.130136f, 0.136370f, 0.142598f, 0.148820f, 0.155037f, 0.161247f, 0.167451f, 0.173648f, 0.179839f, 0.186022f,
0.192198f, 0.198366f, 0.204527f, 0.210679f, 0.216823f, 0.222959f, 0.229086f, 0.235203f, 0.241312f, 0.247410f,
0.253499f, 0.259578f, 0.265647f, 0.271705f, 0.277753f, 0.283789f, 0.289814f, 0.295828f, 0.301830f, 0.307820f,
0.313798f, 0.319764f, 0.325717f, 0.331657f, 0.337584f, 0.343497f, 0.349397f, 0.355283f, 0.361155f, 0.367013f,
0.372856f, 0.378685f, 0.384499f, 0.390297f, 0.396080f, 0.401847f, 0.407598f, 0.413334f, 0.419052f, 0.424755f,
0.430440f, 0.436109f, 0.441760f, 0.447394f, 0.453010f, 0.458608f, 0.464188f, 0.469749f, 0.475292f, 0.480816f,
0.486322f, 0.491808f, 0.497274f, 0.502721f, 0.508148f, 0.513555f, 0.518941f, 0.524307f, 0.529653f, 0.534977f,
0.540280f, 0.545562f, 0.550822f, 0.556060f, 0.561277f, 0.566471f, 0.571643f, 0.576792f, 0.581918f, 0.587022f,
0.592102f, 0.597159f, 0.602192f, 0.607201f, 0.612186f, 0.617147f, 0.622084f, 0.626996f, 0.631883f, 0.636745f,
0.641582f, 0.646394f, 0.651180f, 0.655940f, 0.660675f, 0.665383f, 0.670065f, 0.674720f, 0.679349f, 0.683951f,
0.688526f, 0.693073f, 0.697593f, 0.702086f, 0.706551f, 0.710987f, 0.715396f, 0.719777f, 0.724128f, 0.728452f,
0.732746f, 0.737012f, 0.741248f, 0.745455f, 0.749633f, 0.753780f, 0.757898f, 0.761987f, 0.766044f, 0.770072f,
0.774069f, 0.778036f, 0.781972f, 0.785876f, 0.789750f, 0.793593f, 0.797404f, 0.801183f, 0.804931f, 0.808647f,
0.812331f, 0.815983f, 0.819603f, 0.823190f, 0.826745f, 0.830267f, 0.833756f, 0.837212f, 0.840635f, 0.844024f,
0.847381f, 0.850704f, 0.853993f, 0.857248f, 0.860470f, 0.863657f, 0.866811f, 0.869930f, 0.873014f, 0.876064f,
0.879080f, 0.882060f, 0.885006f, 0.887917f, 0.890792f, 0.893633f, 0.896438f, 0.899207f, 0.901941f, 0.904640f,
0.907302f, 0.909929f, 0.912519f, 0.915074f, 0.917592f, 0.920074f, 0.922520f, 0.924929f, 0.927302f, 0.929638f,
0.931937f, 0.934199f, 0.936424f, 0.938612f, 0.940764f, 0.942877f, 0.944954f, 0.946993f, 0.948995f, 0.950959f,
0.952886f, 0.954775f, 0.956626f, 0.958439f, 0.960215f, 0.961952f, 0.963651f, 0.965313f, 0.966936f, 0.968521f,
0.970067f, 0.971575f, 0.973045f, 0.974476f, 0.975869f, 0.977223f, 0.978538f, 0.979815f, 0.981053f, 0.982252f,
0.983412f, 0.984533f, 0.985616f, 0.986659f, 0.987664f, 0.988629f, 0.989555f, 0.990442f, 0.991290f, 0.992099f,
0.992868f, 0.993599f, 0.994289f, 0.994941f, 0.995553f, 0.996126f, 0.996659f, 0.997153f, 0.997608f, 0.998023f,
0.998398f, 0.998734f, 0.999031f, 0.999288f, 0.999506f, 0.999684f, 0.999822f, 0.999921f, 0.999980f, 1.000000f,
};
static const float SIN_TB[1000] = {
0.000000f, 0.006289f, 0.012579f, 0.018867f, 0.025155f, 0.031442f, 0.037728f, 0.044012f, 0.050295f, 0.056575f,
0.062853f, 0.069129f, 0.075402f, 0.081672f, 0.087939f, 0.094202f, 0.100462f, 0.106717f, 0.112969f, 0.119216f,
0.125458f, 0.131695f, 0.137927f, 0.144154f, 0.150375f, 0.156590f, 0.162799f, 0.169001f, 0.175196f, 0.181385f,
0.187567f, 0.193741f, 0.199907f, 0.206066f, 0.212216f, 0.218358f, 0.224491f, 0.230616f, 0.236731f, 0.242837f,
0.248934f, 0.255020f, 0.261097f, 0.267163f, 0.273218f, 0.279263f, 0.285297f, 0.291319f, 0.297330f, 0.303329f,
0.309316f, 0.315291f, 0.321253f, 0.327203f, 0.333140f, 0.339063f, 0.344974f, 0.350870f, 0.356753f, 0.362621f,
0.368475f, 0.374315f, 0.380140f, 0.385950f, 0.391744f, 0.397523f, 0.403286f, 0.409034f, 0.414765f, 0.420480f,
0.426178f, 0.431859f, 0.437523f, 0.443170f, 0.448799f, 0.454411f, 0.460004f, 0.465580f, 0.471137f, 0.476675f,
0.482195f, 0.487695f, 0.493176f, 0.498638f, 0.504080f, 0.509502f, 0.514903f, 0.520285f, 0.525646f, 0.530986f,
0.536305f, 0.541602f, 0.546879f, 0.552134f, 0.557367f, 0.562577f, 0.567766f, 0.572932f, 0.578076f, 0.583196f,
0.588294f, 0.593368f, 0.598419f, 0.603446f, 0.608450f, 0.613429f, 0.618384f, 0.623314f, 0.628220f, 0.633101f,
0.637957f, 0.642788f, 0.647593f, 0.652373f, 0.657126f, 0.661854f, 0.666556f, 0.671231f, 0.675880f, 0.680502f,
0.685097f, 0.689665f, 0.694206f, 0.698719f, 0.703205f, 0.707662f, 0.712092f, 0.716494f, 0.720867f, 0.725212f,
0.729528f, 0.733815f, 0.738074f, 0.742303f, 0.746502f, 0.750672f, 0.754813f, 0.758923f, 0.763004f, 0.767054f,
0.771074f, 0.775064f, 0.779023f, 0.782951f, 0.786848f, 0.790714f, 0.794548f, 0.798352f, 0.802123f, 0.805863f,
0.809571f, 0.813247f, 0.816891f, 0.820503f, 0.824082f, 0.827628f, 0.831142f, 0.834623f, 0.838071f, 0.841485f,
0.844867f, 0.848215f, 0.851529f, 0.854810f, 0.858057f, 0.861270f, 0.864449f, 0.867593f, 0.870704f, 0.873780f,
0.876821f, 0.879828f, 0.882800f, 0.885737f, 0.888639f, 0.891506f, 0.894337f, 0.897133f, 0.899894f, 0.902619f,
0.905308f, 0.907962f, 0.910580f, 0.913161f, 0.915707f, 0.918216f, 0.920689f, 0.923126f, 0.925526f, 0.927889f,
0.930216f, 0.932506f, 0.934759f, 0.936975f, 0.939154f, 0.941296f, 0.943400f, 0.945467f, 0.947497f, 0.949490f,
0.951444f, 0.953362f, 0.955241f, 0.957083f, 0.958887f, 0.960653f, 0.962381f, 0.964070f, 0.965722f, 0.967336f,
0.968911f, 0.970448f, 0.971946f, 0.973406f, 0.974828f, 0.976211f, 0.977555f, 0.978861f, 0.980128f, 0.981356f,
0.982546f, 0.983696f, 0.984808f, 0.985880f, 0.986914f, 0.987909f, 0.988864f, 0.989781f, 0.990658f, 0.991496f,
0.992295f, 0.993055f, 0.993775f, 0.994456f, 0.995098f, 0.995700f, 0.996263f, 0.996786f, 0.997271f, 0.997715f,
0.998120f, 0.998486f, 0.998812f, 0.999099f, 0.999346f, 0.999554f, 0.999722f, 0.999850f, 0.999939f, 0.999989f,
0.999999f, 0.999969f, 0.999900f, 0.999791f, 0.999643f, 0.999455f, 0.999227f, 0.998961f, 0.998654f, 0.998308f,
0.997923f, 0.997498f, 0.997033f, 0.996530f, 0.995986f, 0.995404f, 0.994782f, 0.994120f, 0.993420f, 0.992680f,
0.991900f, 0.991082f, 0.990224f, 0.989327f, 0.988391f, 0.987416f, 0.986402f, 0.985349f, 0.984257f, 0.983126f,
0.981956f, 0.980747f, 0.979499f, 0.978213f, 0.976888f, 0.975524f, 0.974122f, 0.972681f, 0.971202f, 0.969684f,
0.968128f, 0.966534f, 0.964901f, 0.963230f, 0.961521f, 0.959774f, 0.957990f, 0.956167f, 0.954306f, 0.952408f,
0.950472f, 0.948498f, 0.946487f, 0.944438f, 0.942352f, 0.940229f, 0.938069f, 0.935871f, 0.933637f, 0.931365f,
0.929057f, 0.926712f, 0.924330f, 0.921912f, 0.919457f, 0.916966f, 0.914439f, 0.911875f, 0.909275f, 0.906640f,
0.903968f, 0.901261f, 0.898518f, 0.895740f, 0.892926f, 0.890077f, 0.887192f, 0.884273f, 0.881318f, 0.878329f,
0.875305f, 0.872246f, 0.869153f, 0.866025f, 0.862864f, 0.859668f, 0.856438f, 0.853174f, 0.849876f, 0.846545f,
0.843180f, 0.839782f, 0.836351f, 0.832886f, 0.829389f, 0.825859f, 0.822296f, 0.818701f, 0.815073f, 0.811413f,
0.807721f, 0.803997f, 0.800241f, 0.796454f, 0.792635f, 0.788785f, 0.784903f, 0.780990f, 0.777047f, 0.773073f,
0.769068f, 0.765033f, 0.760967f, 0.756872f, 0.752746f, 0.748591f, 0.744406f, 0.740192f, 0.735948f, 0.731675f,
0.727374f, 0.723043f, 0.718684f, 0.714297f, 0.709881f, 0.705437f, 0.700965f, 0.696466f, 0.691939f, 0.687384f,
0.682803f, 0.678194f, 0.673559f, 0.668897f, 0.664208f, 0.659494f, 0.654753f, 0.649986f, 0.645193f, 0.640375f,
0.635532f, 0.630664f, 0.625770f, 0.620852f, 0.615909f, 0.610942f, 0.605951f, 0.600936f, 0.595897f, 0.590834f,
0.585748f, 0.580639f, 0.575507f, 0.570352f, 0.565175f, 0.559975f, 0.554753f, 0.549509f, 0.544243f, 0.538956f,
0.533648f, 0.528318f, 0.522968f, 0.517597f, 0.512205f, 0.506793f, 0.501361f, 0.495909f, 0.490438f, 0.484947f,
0.479437f, 0.473908f, 0.468361f, 0.462794f, 0.457210f, 0.451607f, 0.445987f, 0.440349f, 0.434693f, 0.429020f,
0.423331f, 0.417624f, 0.411901f, 0.406162f, 0.400407f, 0.394636f, 0.388849f, 0.383047f, 0.377229f, 0.371397f,
0.365550f, 0.359689f, 0.353813f, 0.347924f, 0.342020f, 0.336103f, 0.330173f, 0.324230f, 0.318274f, 0.312305f,
0.306324f, 0.300331f, 0.294326f, 0.288309f, 0.282281f, 0.276242f, 0.270192f, 0.264131f, 0.258060f, 0.251978f,
0.245887f, 0.239785f, 0.233675f, 0.227555f, 0.221426f, 0.215288f, 0.209142f, 0.202987f, 0.196825f, 0.190655f,
0.184477f, 0.178292f, 0.172099f, 0.165900f, 0.159695f, 0.153483f, 0.147265f, 0.141041f, 0.134812f, 0.128577f,
0.122338f, 0.116093f, 0.109844f, 0.103590f, 0.097333f, 0.091071f, 0.084806f, 0.078537f, 0.072266f, 0.065991f,
0.059714f, 0.053435f, 0.047154f, 0.040870f, 0.034585f, 0.028299f, 0.022011f, 0.015723f, 0.009434f, 0.003145f,
-0.003145f, -0.009434f, -0.015723f, -0.022011f, -0.028299f, -0.034585f, -0.040870f, -0.047154f, -0.053435f, -0.059714f,
-0.065991f, -0.072266f, -0.078537f, -0.084806f, -0.091071f, -0.097333f, -0.103590f, -0.109844f, -0.116093f, -0.122338f,
-0.128577f, -0.134812f, -0.141041f, -0.147265f, -0.153483f, -0.159695f, -0.165900f, -0.172099f, -0.178292f, -0.184477f,
-0.190655f, -0.196825f, -0.202987f, -0.209142f, -0.215288f, -0.221426f, -0.227555f, -0.233675f, -0.239785f, -0.245887f,
-0.251978f, -0.258060f, -0.264131f, -0.270192f, -0.276242f, -0.282281f, -0.288309f, -0.294326f, -0.300331f, -0.306324f,
-0.312305f, -0.318274f, -0.324230f, -0.330173f, -0.336103f, -0.342020f, -0.347924f, -0.353813f, -0.359689f, -0.365550f,
-0.371397f, -0.377229f, -0.383047f, -0.388849f, -0.394636f, -0.400407f, -0.406162f, -0.411901f, -0.417624f, -0.423331f,
-0.429020f, -0.434693f, -0.440349f, -0.445987f, -0.451607f, -0.457210f, -0.462794f, -0.468361f, -0.473908f, -0.479437f,
-0.484947f, -0.490438f, -0.495909f, -0.501361f, -0.506793f, -0.512205f, -0.517597f, -0.522968f, -0.528318f, -0.533648f,
-0.538956f, -0.544243f, -0.549509f, -0.554753f, -0.559975f, -0.565175f, -0.570352f, -0.575507f, -0.580639f, -0.585748f,
-0.590834f, -0.595897f, -0.600936f, -0.605951f, -0.610942f, -0.615909f, -0.620852f, -0.625770f, -0.630664f, -0.635532f,
-0.640375f, -0.645193f, -0.649986f, -0.654753f, -0.659494f, -0.664208f, -0.668897f, -0.673559f, -0.678194f, -0.682803f,
-0.687384f, -0.691939f, -0.696466f, -0.700965f, -0.705437f, -0.709881f, -0.714297f, -0.718684f, -0.723043f, -0.727374f,
-0.731675f, -0.735948f, -0.740192f, -0.744406f, -0.748591f, -0.752746f, -0.756872f, -0.760967f, -0.765033f, -0.769068f,
-0.773073f, -0.777047f, -0.780990f, -0.784903f, -0.788785f, -0.792635f, -0.796454f, -0.800241f, -0.803997f, -0.807721f,
-0.811413f, -0.815073f, -0.818701f, -0.822296f, -0.825859f, -0.829389f, -0.832886f, -0.836351f, -0.839782f, -0.843180f,
-0.846545f, -0.849876f, -0.853174f, -0.856438f, -0.859668f, -0.862864f, -0.866025f, -0.869153f, -0.872246f, -0.875305f,
-0.878329f, -0.881318f, -0.884273f, -0.887192f, -0.890077f, -0.892926f, -0.895740f, -0.898518f, -0.901261f, -0.903968f,
-0.906640f, -0.909275f, -0.911875f, -0.914439f, -0.916966f, -0.919457f, -0.921912f, -0.924330f, -0.926712f, -0.929057f,
-0.931365f, -0.933637f, -0.935871f, -0.938069f, -0.940229f, -0.942352f, -0.944438f, -0.946487f, -0.948498f, -0.950472f,
-0.952408f, -0.954306f, -0.956167f, -0.957990f, -0.959774f, -0.961521f, -0.963230f, -0.964901f, -0.966534f, -0.968128f,
-0.969684f, -0.971202f, -0.972681f, -0.974122f, -0.975524f, -0.976888f, -0.978213f, -0.979499f, -0.980747f, -0.981956f,
-0.983126f, -0.984257f, -0.985349f, -0.986402f, -0.987416f, -0.988391f, -0.989327f, -0.990224f, -0.991082f, -0.991900f,
-0.992680f, -0.993420f, -0.994120f, -0.994782f, -0.995404f, -0.995986f, -0.996530f, -0.997033f, -0.997498f, -0.997923f,
-0.998308f, -0.998654f, -0.998961f, -0.999227f, -0.999455f, -0.999643f, -0.999791f, -0.999900f, -0.999969f, -0.999999f,
-0.999989f, -0.999939f, -0.999850f, -0.999722f, -0.999554f, -0.999346f, -0.999099f, -0.998812f, -0.998486f, -0.998120f,
-0.997715f, -0.997271f, -0.996786f, -0.996263f, -0.995700f, -0.995098f, -0.994456f, -0.993775f, -0.993055f, -0.992295f,
-0.991496f, -0.990658f, -0.989781f, -0.988864f, -0.987909f, -0.986914f, -0.985880f, -0.984808f, -0.983696f, -0.982546f,
-0.981356f, -0.980128f, -0.978861f, -0.977555f, -0.976211f, -0.974828f, -0.973406f, -0.971946f, -0.970448f, -0.968911f,
-0.967336f, -0.965722f, -0.964070f, -0.962381f, -0.960653f, -0.958887f, -0.957083f, -0.955241f, -0.953362f, -0.951444f,
-0.949490f, -0.947497f, -0.945467f, -0.943400f, -0.941296f, -0.939154f, -0.936975f, -0.934759f, -0.932506f, -0.930216f,
-0.927889f, -0.925526f, -0.923126f, -0.920689f, -0.918216f, -0.915707f, -0.913161f, -0.910580f, -0.907962f, -0.905308f,
-0.902619f, -0.899894f, -0.897133f, -0.894337f, -0.891506f, -0.888639f, -0.885737f, -0.882800f, -0.879828f, -0.876821f,
-0.873780f, -0.870704f, -0.867593f, -0.864449f, -0.861270f, -0.858057f, -0.854810f, -0.851529f, -0.848215f, -0.844867f,
-0.841485f, -0.838071f, -0.834623f, -0.831142f, -0.827628f, -0.824082f, -0.820503f, -0.816891f, -0.813247f, -0.809571f,
-0.805863f, -0.802123f, -0.798352f, -0.794548f, -0.790714f, -0.786848f, -0.782951f, -0.779023f, -0.775064f, -0.771074f,
-0.767054f, -0.763004f, -0.758923f, -0.754813f, -0.750672f, -0.746502f, -0.742303f, -0.738074f, -0.733815f, -0.729528f,
-0.725212f, -0.720867f, -0.716494f, -0.712092f, -0.707662f, -0.703205f, -0.698719f, -0.694206f, -0.689665f, -0.685097f,
-0.680502f, -0.675880f, -0.671231f, -0.666556f, -0.661854f, -0.657126f, -0.652373f, -0.647593f, -0.642788f, -0.637957f,
-0.633101f, -0.628220f, -0.623314f, -0.618384f, -0.613429f, -0.608450f, -0.603446f, -0.598419f, -0.593368f, -0.588294f,
-0.583196f, -0.578076f, -0.572932f, -0.567766f, -0.562577f, -0.557367f, -0.552134f, -0.546879f, -0.541602f, -0.536305f,
-0.530986f, -0.525646f, -0.520285f, -0.514903f, -0.509502f, -0.504080f, -0.498638f, -0.493176f, -0.487695f, -0.482195f,
-0.476675f, -0.471137f, -0.465580f, -0.460004f, -0.454411f, -0.448799f, -0.443170f, -0.437523f, -0.431859f, -0.426178f,
-0.420480f, -0.414765f, -0.409034f, -0.403286f, -0.397523f, -0.391744f, -0.385950f, -0.380140f, -0.374315f, -0.368475f,
-0.362621f, -0.356753f, -0.350870f, -0.344974f, -0.339063f, -0.333140f, -0.327203f, -0.321253f, -0.315291f, -0.309316f,
-0.303329f, -0.297330f, -0.291319f, -0.285297f, -0.279263f, -0.273218f, -0.267163f, -0.261097f, -0.255020f, -0.248934f,
-0.242837f, -0.236731f, -0.230616f, -0.224491f, -0.218358f, -0.212216f, -0.206066f, -0.199907f, -0.193741f, -0.187567f,
-0.181385f, -0.175196f, -0.169001f, -0.162799f, -0.156590f, -0.150375f, -0.144154f, -0.137927f, -0.131695f, -0.125458f,
-0.119216f, -0.112969f, -0.106717f, -0.100462f, -0.094202f, -0.087939f, -0.081672f, -0.075402f, -0.069129f, -0.062853f,
-0.056575f, -0.050295f, -0.044012f, -0.037728f, -0.031442f, -0.025155f, -0.018867f, -0.012579f, -0.006289f, -0.000000f,};
int GetAngleIdx(float eangle){
    int period = (int)(eangle/360);
    eangle -= period*360.0;
    
    //if (eangle >= 360) eangle-=360;
    //else 
        if (eangle < 0) {
            eangle += 360;
        }
    period = (int)(eangle *1000/360-0.5);
    if (period < 0) period = 0;
    if (period >= 1000) period = 999;
    //if (period>=1000) rt_kprintf("index: %d\n", period);
    return period;   
}    
                                    
float Svpwm_PhaseA(float elec_ratio, float elec_angle){	
	float coef = elec_ratio;
	float result = 0.f;
    int idx = 0;
	if (elec_angle >= (300.f)) {
        idx = GetAngleIdx(elec_angle+30);
		result = (0.5f + 0.5f*coef*COS_TB[idx]);//OK
	}
	else if (elec_angle >= (240.f)) {
        idx = GetAngleIdx(elec_angle);
		result = (0.5f + 0.5f*SQRT_3*coef*COS_TB[idx]);//OK
	}
	else if (elec_angle >= (180.f))	{
        idx = GetAngleIdx(elec_angle + 60);
		result = (0.5f + 0.5f*coef*SIN_TB[idx]);//OK
	}
	else if (elec_angle >= (120.f))	{
        idx = GetAngleIdx(elec_angle + 30);
		result = (0.5f + 0.5f*coef*COS_TB[idx]);//OK
	}
	else if (elec_angle >= (60.f)) {
        idx = GetAngleIdx(elec_angle);    
		result = (0.5f + 0.5f*SQRT_3*coef*COS_TB[idx]);//OK
	}
	else {
        idx = GetAngleIdx(elec_angle + 60);
		result = (0.5f + 0.5f*coef*SIN_TB[idx]);//OK
	}
	return result;
}
	
float Svpwm_PhaseB(float elec_ratio, float elec_angle){
	float coef = elec_ratio;
	float result = 0.f;
    int idx = 0;

	if (elec_angle >= (300.f)) {
        idx = GetAngleIdx(elec_angle-60);
		result = (0.5f + 0.5f*coef*SIN_TB[idx]);//OK
	}
	else if (elec_angle >= (240.f)) {
        idx = GetAngleIdx(elec_angle);
		result = (0.5f + 0.5f*coef*SIN_TB[idx]);//OK
	}
	else if (elec_angle >= (180.f)) {
        idx = GetAngleIdx(elec_angle + 60);
		result = (0.5f - 0.5f*SQRT_3*coef*COS_TB[idx]);//OK
	}
	else if (elec_angle >= (120.f)) {
        idx = GetAngleIdx(elec_angle-60);
		result = (0.5f + 0.5f*coef*SIN_TB[idx]);//OK
	}
	else if (elec_angle >= (60.f)) {
        idx = GetAngleIdx(elec_angle);
		result = (0.5f + 0.5f*coef*SIN_TB[idx]);//OK
	}
	else {
        idx = GetAngleIdx(elec_angle + 60);
		result = (0.5f - 0.5f*SQRT_3*coef*COS_TB[idx]);//OK
	}
	return result;
}
float Svpwm_PhaseC(float elec_ratio, float elec_angle){
	float coef = elec_ratio;
	float result = 0.f;
    int idx = 0;

	if (elec_angle >= (300.f)) {
        idx = GetAngleIdx(elec_angle+30);
		result = (0.5f - 0.5f*SQRT_3*coef*SIN_TB[idx]);//OK
	}
	else if (elec_angle >= (240.f)) {
        idx = GetAngleIdx(elec_angle);
		result = (0.5f - 0.5f*coef*SIN_TB[idx]);//OK
	}
	else if (elec_angle >= (180.f)) {
        idx = GetAngleIdx(elec_angle + 60);
		result = (0.5f - 0.5f*coef*SIN_TB[idx]);//OK
	}
	else if (elec_angle >= (120.f))	{
        idx = GetAngleIdx(elec_angle + 30);     
		result = (0.5f - 0.5f*SQRT_3*coef*SIN_TB[idx]);//OK
	}
	else if (elec_angle >= (60.f)) {
        idx = GetAngleIdx(elec_angle);     
		result = (0.5f - 0.5f*coef*SIN_TB[idx]);//OK
	}
	else {
        idx = GetAngleIdx(elec_angle + 60);     
		result = (0.5f - 0.5f*coef*SIN_TB[idx]);//OK
	}	
	return result;
}
#else
#include <svpwmtable.h>
int GetAngleIdx(float eangle){
    int period = (int)(eangle/360);
    eangle -= period*360.0;
    if (eangle < 0) {
				eangle += 360;
		}
    period = (int)(eangle *1000/360);
    //if (period < 0) period = 0;
    //if (period >= 1000) period = 999;
		if ((period>=1000)|| (period < 0)) rt_kprintf("index: %d\n", period);
    //if (period>=1000) rt_kprintf("index: %d\n", period);
    return period;   
} 
float Svpwm_PhaseA(float elec_ratio, float elec_angle){	
	int idx = GetAngleIdx(elec_angle);
	return 	0.5f + acnl[idx]*elec_ratio;
}
float Svpwm_PhaseB(float elec_ratio, float elec_angle){	
	int idx = GetAngleIdx(elec_angle);
	return 	0.5f + bcnl[idx]*elec_ratio;
}
float Svpwm_PhaseC(float elec_ratio, float elec_angle){	
	int idx = GetAngleIdx(elec_angle);
	return 	0.5f + ccnl[idx]*elec_ratio;
}
void Svpwm_PhaseABC(float elec_ratio, float elec_angle, SvpwmResult_t* res){	
	int idx = GetAngleIdx(elec_angle);
	res->a = 0.5f + acnl[idx]*elec_ratio;
	res->b = 0.5f + bcnl[idx]*elec_ratio;
	res->c = 0.5f + ccnl[idx]*elec_ratio;
}


#endif
